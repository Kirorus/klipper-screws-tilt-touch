########################################
# Auto screws tilt via Cartographer TOUCH
# - Requires: `klippy/extras/screws_tilt_touch.py`
# - Provides command: `SCREWS_TILT_TOUCH_CALCULATE`
########################################
##
## For default Klipper method.
## It doesn't work with Cartographer now.
##
[screws_tilt_adjust]
screw1: 43,23
screw1_name: front left screw
screw2: 302,23
screw2_name: front right screw
screw3: 272,272
screw3_name: rear right screw
screw4: 72,272
screw4_name: rear left screw
horizontal_move_z: 10
speed: 150
screw_thread: CW-M4
#################################


[screws_tilt_touch]
# `screwN` — это XY положения СОПЛА над центром винта (обычные X/Y координаты Klipper).
#
# Важно: `CARTOGRAPHER_TOUCH_PROBE` меряет касанием СОПЛА, поэтому оффсет катушки
# тут НЕ применяется к точкам винтов.
#
# Для справки (геометрия катушки относительно сопла из `cartographer.cfg`):
#   coil_xy = nozzle_xy + (x_offset, y_offset)
#
# Если ты ограничиваешь [bed_mesh] из-за зоны очистки сопла, то для этой команды
# можно включить временное расширение touch-boundaries (только на время калибровки),
# чтобы не приходилось вручную менять mesh_min/mesh_max.
override_touch_bounds: 1
override_touch_bounds_margin: 1.0

screw1: 19,23
screw1_name: front left screw
screw2: 278,23
screw2_name: front right screw
screw3: 248,272
screw3_name: rear right screw
screw4: 48,272
screw4_name: rear left screw

# travel settings
horizontal_move_z: 10
speed: 150

# thread/pitch for guidance output
screw_thread: CW-M4
pitch: 0.70


[gcode_macro SCREWS_CALIBRATION]
description: Auto bed screws calibration via Cartographer TOUCH.
gcode:
  {% if printer.toolhead.homed_axes != "xyz" %}
    G28
  {% endif %}
  # Tip: keep nozzle temperature below Cartographer touch limit.
  SCREWS_TILT_TOUCH_CALCULATE BASE={params.BASE|default("AVERAGE")} TOL={params.TOL|default(0.02)} SPEED={params.SPEED|default(150)} Z={params.Z|default(10)}

